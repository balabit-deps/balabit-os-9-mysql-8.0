From d0c1edd866cb69eaace5fd204a3c3e4ebdc726a6 Mon Sep 17 00:00:00 2001
From: Corey Bryant <corey.bryant@canonical.com>
Date: Fri, 27 Jan 2023 17:03:05 -0500
Subject: [PATCH 11/86] Revert "Bug#34824457 logs missing on unclean process
 exit"

This reverts commit 056a2df666fd537db794003f4f669c52be07e9c8.
---
 router/tests/helpers/procs.h                        | 13 ++++++++-----
 .../integration/test_routing_sharing_restart.cc     |  4 ++++
 2 files changed, 12 insertions(+), 5 deletions(-)

diff --git a/router/tests/helpers/procs.h b/router/tests/helpers/procs.h
index f87130fa55f..db9aff7a12e 100644
--- a/router/tests/helpers/procs.h
+++ b/router/tests/helpers/procs.h
@@ -50,20 +50,23 @@ class Procs : public ProcessManager {
    * shutdown and stop monitoring of processes.
    */
   void clear() {
-    shutdown_all();
-    ensure_clean_exit();
-
     if (::testing::Test::HasFatalFailure() || dump_logs_) {
       dump_all();
     }
 
-    // it will call shutdown again ...
     ProcessManager::clear();
   }
 
   void shutdown_all() { ProcessManager::shutdown_all(); }
 
-  ~Procs() override { clear(); }
+  ~Procs() override {
+    shutdown_all();
+    ensure_clean_exit();
+
+    if (::testing::Test::HasFatalFailure() || dump_logs_) {
+      dump_all();
+    }
+  }
 
   void dump_logs() { dump_logs_ = true; }
 
diff --git a/router/tests/integration/test_routing_sharing_restart.cc b/router/tests/integration/test_routing_sharing_restart.cc
index b2c3232d819..4941519b7fd 100644
--- a/router/tests/integration/test_routing_sharing_restart.cc
+++ b/router/tests/integration/test_routing_sharing_restart.cc
@@ -1225,6 +1225,10 @@ class ShareConnectionTestWithRestartedServer
   void TearDown() override {
     for (auto &inter : intermediate_routers_) {
       if (!inter->is_running()) {
+        if (::testing::Test::HasFatalFailure()) {
+          inter->process_manager().dump_logs();
+        }
+
         inter->process_manager().clear();
       }
     }
-- 
2.37.2


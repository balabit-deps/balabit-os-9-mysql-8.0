From 2d88be379412a8f6f9ec25033b8c1127c9a04a54 Mon Sep 17 00:00:00 2001
From: Corey Bryant <corey.bryant@canonical.com>
Date: Fri, 27 Jan 2023 17:19:04 -0500
Subject: [PATCH 60/86] Revert "WL#12772 connection-sharing [17/28] -
 list-fields"

This reverts commit 16bbfe77a3190cb0b343810ebe4e1987a4c763b8.
---
 router/src/routing/src/CMakeLists.txt         |   1 -
 router/src/routing/src/classic_list_fields.cc | 178 ------------------
 router/src/routing/src/classic_list_fields.h  |  60 ------
 3 files changed, 239 deletions(-)
 delete mode 100644 router/src/routing/src/classic_list_fields.cc
 delete mode 100644 router/src/routing/src/classic_list_fields.h

diff --git a/router/src/routing/src/CMakeLists.txt b/router/src/routing/src/CMakeLists.txt
index f7685e9a42b..2bb292b3eca 100644
--- a/router/src/routing/src/CMakeLists.txt
+++ b/router/src/routing/src/CMakeLists.txt
@@ -57,7 +57,6 @@ ADD_LIBRARY(routing SHARED
   classic_init_schema.cc
   classic_kill.cc
   classic_lazy_connect.cc
-  classic_list_fields.cc
   classic_ping.cc
   classic_query.cc
   classic_quit.cc
diff --git a/router/src/routing/src/classic_list_fields.cc b/router/src/routing/src/classic_list_fields.cc
deleted file mode 100644
index ddc02d691fc..00000000000
--- a/router/src/routing/src/classic_list_fields.cc
+++ /dev/null
@@ -1,178 +0,0 @@
-/*
-  Copyright (c) 2022, Oracle and/or its affiliates.
-
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License, version 2.0,
-  as published by the Free Software Foundation.
-
-  This program is also distributed with certain software (including
-  but not limited to OpenSSL) that is licensed under separate terms,
-  as designated in a particular file or component or in included license
-  documentation.  The authors of MySQL hereby grant you an additional
-  permission to link the program and your derivative works with the
-  separately licensed software that they have included with MySQL.
-
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
-*/
-
-#include "classic_list_fields.h"
-
-#include "classic_connection.h"
-#include "classic_forwarder.h"
-#include "classic_frame.h"
-#include "classic_lazy_connect.h"
-#include "mysql/harness/stdx/expected.h"
-#include "mysql/harness/tls_error.h"
-#include "tracer.h"
-
-/**
- * forward the list-fields message flow.
- *
- * Expected overall flow:
- *
- * @code
- * c->s: COM_LIST_FIELDS
- * alt table exists
- * loop
- * c<-s: Column
- * endloop
- * c<-s: Eof
- * else
- * c<-s: Error
- * end
- * @endcode
- *
- * If there is no server connection, it is created on demand.
- */
-stdx::expected<Processor::Result, std::error_code>
-ListFieldsForwarder::process() {
-  switch (stage()) {
-    case Stage::Command:
-      return command();
-    case Stage::Connect:
-      return connect();
-    case Stage::Connected:
-      return connected();
-    case Stage::Response:
-      return response();
-    case Stage::Eof:
-      return eof();
-    case Stage::Error:
-      return error();
-    case Stage::Done:
-      return Result::Done;
-  }
-
-  harness_assert_this_should_not_execute();
-}
-
-stdx::expected<Processor::Result, std::error_code>
-ListFieldsForwarder::command() {
-  trace(Tracer::Event().stage("list_fields::command"));
-
-  auto &server_conn = connection()->socket_splicer()->server_conn();
-  if (!server_conn.is_open()) {
-    stage(Stage::Connect);
-    return Result::Again;
-  } else {
-    stage(Stage::Response);
-    return forward_client_to_server();
-  }
-}
-
-stdx::expected<Processor::Result, std::error_code>
-ListFieldsForwarder::connect() {
-  trace(Tracer::Event().stage("list_fields::connect"));
-
-  stage(Stage::Connected);
-
-  connection()->push_processor(std::make_unique<LazyConnector>(
-      connection(), false /* not in handshake */));
-
-  return Result::Again;
-}
-
-stdx::expected<Processor::Result, std::error_code>
-ListFieldsForwarder::connected() {
-  auto &server_conn = connection()->socket_splicer()->server_conn();
-  if (!server_conn.is_open()) {
-    // Connector sent an server::Error already.
-    auto *socket_splicer = connection()->socket_splicer();
-    auto src_channel = socket_splicer->client_channel();
-    auto src_protocol = connection()->client_protocol();
-
-    // take the client::command from the connection.
-    auto recv_res =
-        ClassicFrame::ensure_has_full_frame(src_channel, src_protocol);
-    if (!recv_res) return recv_client_failed(recv_res.error());
-
-    discard_current_msg(src_channel, src_protocol);
-
-    trace(Tracer::Event().stage("list_fields::error"));
-
-    stage(Stage::Done);
-    return Result::Again;
-  }
-
-  trace(Tracer::Event().stage("list_fields::connected"));
-
-  stage(Stage::Response);
-  return forward_client_to_server();
-}
-
-stdx::expected<Processor::Result, std::error_code>
-ListFieldsForwarder::response() {
-  auto *socket_splicer = connection()->socket_splicer();
-  auto src_channel = socket_splicer->server_channel();
-  auto src_protocol = connection()->server_protocol();
-
-  auto read_res =
-      ClassicFrame::ensure_has_msg_prefix(src_channel, src_protocol);
-  if (!read_res) return recv_server_failed(read_res.error());
-
-  const uint8_t msg_type = src_protocol->current_msg_type().value();
-
-  enum class Msg {
-    Eof = ClassicFrame::cmd_byte<classic_protocol::message::server::Eof>(),
-    Error = ClassicFrame::cmd_byte<classic_protocol::message::server::Error>(),
-  };
-
-  switch (Msg{msg_type}) {
-    case Msg::Eof:
-      stage(Stage::Eof);
-      return Result::Again;
-    case Msg::Error:
-      stage(Stage::Error);
-      return Result::Again;
-  }
-
-  trace(Tracer::Event().stage("list_fields::column"));
-
-  // don't force the flush to the client as more messages from the server
-  // follow.
-  return forward_server_to_client(true /* noflush */);
-}
-
-stdx::expected<Processor::Result, std::error_code> ListFieldsForwarder::eof() {
-  trace(Tracer::Event().stage("list_fields::end_of_columns"));
-
-  stage(Stage::Done);
-
-  return forward_server_to_client();
-}
-
-stdx::expected<Processor::Result, std::error_code>
-ListFieldsForwarder::error() {
-  trace(Tracer::Event().stage("list_fields::error"));
-
-  stage(Stage::Done);
-
-  return forward_server_to_client();
-}
diff --git a/router/src/routing/src/classic_list_fields.h b/router/src/routing/src/classic_list_fields.h
deleted file mode 100644
index dd194e7af7b..00000000000
--- a/router/src/routing/src/classic_list_fields.h
+++ /dev/null
@@ -1,60 +0,0 @@
-/*
-  Copyright (c) 2022, Oracle and/or its affiliates.
-
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License, version 2.0,
-  as published by the Free Software Foundation.
-
-  This program is also distributed with certain software (including
-  but not limited to OpenSSL) that is licensed under separate terms,
-  as designated in a particular file or component or in included license
-  documentation.  The authors of MySQL hereby grant you an additional
-  permission to link the program and your derivative works with the
-  separately licensed software that they have included with MySQL.
-
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
-*/
-
-#ifndef ROUTING_CLASSIC_LIST_FIELDS_INCLUDED
-#define ROUTING_CLASSIC_LIST_FIELDS_INCLUDED
-
-#include "processor.h"
-
-class ListFieldsForwarder : public Processor {
- public:
-  using Processor::Processor;
-
-  enum class Stage {
-    Command,
-    Connect,
-    Connected,
-    Response,
-    Eof,
-    Error,
-    Done,
-  };
-
-  stdx::expected<Result, std::error_code> process() override;
-
-  void stage(Stage stage) { stage_ = stage; }
-  Stage stage() const { return stage_; }
-
- private:
-  stdx::expected<Result, std::error_code> command();
-  stdx::expected<Result, std::error_code> connect();
-  stdx::expected<Result, std::error_code> connected();
-  stdx::expected<Result, std::error_code> response();
-  stdx::expected<Result, std::error_code> eof();
-  stdx::expected<Result, std::error_code> error();
-
-  Stage stage_{Stage::Command};
-};
-
-#endif
-- 
2.37.2


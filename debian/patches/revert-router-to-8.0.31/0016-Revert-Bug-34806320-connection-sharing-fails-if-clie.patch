From 98a95a87677031bd263c5791f8380f06c20d008d Mon Sep 17 00:00:00 2001
From: Corey Bryant <corey.bryant@canonical.com>
Date: Fri, 27 Jan 2023 17:03:36 -0500
Subject: [PATCH 16/86] Revert "Bug#34806320 connection sharing fails if client
 via unix-socket"

This reverts commit 42c0e8a69d8e9de719df45ba7c6281a0169c5e0d.
---
 router/src/routing/src/classic_greeting.cc | 19 ++++++-------------
 1 file changed, 6 insertions(+), 13 deletions(-)

diff --git a/router/src/routing/src/classic_greeting.cc b/router/src/routing/src/classic_greeting.cc
index 62015075fc2..d7e48efc6db 100644
--- a/router/src/routing/src/classic_greeting.cc
+++ b/router/src/routing/src/classic_greeting.cc
@@ -399,19 +399,10 @@ ClientGreetor::client_greeting() {
   if (!src_protocol->shared_capabilities().test(
           classic_protocol::capabilities::pos::ssl)) {
     // client wants to stay with plaintext
-
-    if (msg.auth_method_data() == "\x00"sv) {
+    if (src_protocol->auth_method_name() == AuthCachingSha2Password::kName &&
+        msg.auth_method_data() == "\x00"sv) {
       // password is empty.
       src_protocol->password("");
-    } else {
-      const bool client_conn_is_secure =
-          connection()->socket_splicer()->client_conn().is_secure_transport();
-
-      if (client_conn_is_secure &&
-          src_protocol->auth_method_name() == AuthCachingSha2Password::kName) {
-        stage(Stage::RequestPlaintextPassword);
-        return Result::Again;
-      }
     }
 
     stage(Stage::Accepted);
@@ -579,8 +570,10 @@ ClientGreetor::client_greeting_after_tls() {
 
     stage(Stage::Accepted);
     return Result::Again;
-  } else if (kCapturePlaintextPassword && src_protocol->auth_method_name() ==
-                                              AuthCachingSha2Password::kName) {
+  } else if (kCapturePlaintextPassword &&
+             src_protocol->auth_method_name() ==
+                 AuthCachingSha2Password::kName &&
+             src_channel->is_tls()) {
     stage(Stage::RequestPlaintextPassword);
     return Result::Again;
   } else {
-- 
2.37.2

